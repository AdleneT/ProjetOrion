generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum JobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
  NEEDS_RETRY
}

enum JobStepName {
  product_intel
  ugc_strategy
  creative
  humanize_qa
  tts
  video_gen
  assemble
  deliver
}

enum StepStatus {
  queued
  running
  succeeded
  failed
}

enum Platform {
  tiktok_ads
  tiktok_shop
  meta_ads
}

enum AgentName {
  product_intel
  ugc_strategist
  creative_director
  humanize_qa
}

enum AssetType {
  script
  audio
  video
  subtitles
  image
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password_hash String?
  createdAt     DateTime @default(now())
  jobs          Job[]
}

model Influencer {
  id                String   @id // e.g., "emma_ugc"
  name              String
  language          String
  persona           Json // style, vocab, do/dont, pacing, energy, etc.
  elevenlabsVoiceId String
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  jobs              Job[]
}

model Job {
  id           String      @id @default(uuid())
  userId       String?
  user         User?       @relation(fields: [userId], references: [id])
  status       JobStatus   @default(QUEUED)
  platform     Platform
  input        Json // Brief user
  influencerId String?
  influencer   Influencer? @relation(fields: [influencerId], references: [id])
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  startedAt    DateTime?
  finishedAt   DateTime?
  runId        String      @unique @default(uuid())
  error        String?

  steps  JobStep[]
  assets Asset[]

  @@index([userId])
  @@index([status])
}

model JobStep {
  id         String      @id @default(uuid())
  jobId      String
  job        Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  step       JobStepName
  status     StepStatus  @default(queued)
  startedAt  DateTime?
  finishedAt DateTime?
  input      Json?
  output     Json?
  error      String?

  @@index([jobId])
}

model PromptVersion {
  id        String    @id @default(uuid())
  agentName AgentName
  version   String
  prompt    String    @db.Text
  createdAt DateTime  @default(now())
  isActive  Boolean   @default(true)
}

model Asset {
  id        String    @id @default(uuid())
  jobId     String
  job       Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  type      AssetType
  url       String
  metadata  Json?
  createdAt DateTime  @default(now())

  @@index([jobId])
}
